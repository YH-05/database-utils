# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術 | バージョン |
|------|-----------|
| Python | 3.12+ |
| uv | latest |
| SQLite | 3.35+ |

### フレームワーク・ライブラリ

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| structlog | >=25.4.0 | 構造化ログ | コンテキスト付きログ、JSON出力対応 |
| rich | >=13.7.0 | コンソール表示 | structlogのレンダリング |
| filelock | >=3.20.1 | ファイルロック | バックアップ時の排他制御 |

### 開発ツール

| 技術 | バージョン | 用途 | 選定理由 |
|------|-----------|------|----------|
| Ruff | latest | リント・フォーマット | 高速、Python標準に準拠 |
| pyright | latest | 型チェック | 厳密な型チェック |
| pytest | >=8.0.0 | テスト | Pythonの標準的なテストフレームワーク |
| Hypothesis | >=6.0.0 | プロパティベーステスト | 自動テストケース生成 |
| pytest-cov | >=5.0.0 | カバレッジ | テストカバレッジ計測 |

## アーキテクチャパターン

### リポジトリパターン + 識別子解決層

```
┌─────────────────────────────────────┐
│   公開API層                          │ ← DatabaseConnection, IdentifierResolver
│   (database_utils)                  │
├─────────────────────────────────────┤
│   識別子解決層                        │ ← 外部ID → 内部ID変換
│   (IdentifierResolver)              │
├─────────────────────────────────────┤
│   リポジトリ層                        │ ← データアクセス抽象化
│   (SecurityRepo, PriceRepo, etc.)   │
├─────────────────────────────────────┤
│   データ層                           │ ← SQLite
│   (sqlite3)                         │
└─────────────────────────────────────┘
```

#### 公開API層
- **責務**: ユーザー向けの高レベルAPI提供
- **許可される操作**: 識別子解決層・リポジトリ層の呼び出し
- **禁止される操作**: 直接的なSQLの実行

#### 識別子解決層
- **責務**: 外部識別子から内部IDへの変換
- **許可される操作**: リポジトリ層への問い合わせ
- **禁止される操作**: データの永続化

#### リポジトリ層
- **責務**: 各エンティティのCRUD操作
- **許可される操作**: SQLの実行、トランザクション管理
- **禁止される操作**: ビジネスロジックの実装

#### データ層
- **責務**: SQLiteデータベースへのアクセス
- **許可される操作**: ファイルI/O
- **禁止される操作**: なし

## データ永続化戦略

### ストレージ方式

| データ種別 | ストレージ | フォーマット | 理由 |
|-----------|----------|-------------|------|
| マスタデータ | SQLite | テーブル | 参照整合性、インデックス |
| 時系列データ | SQLite | テーブル | 日付範囲クエリの効率性 |
| バックアップ | SQLite | ファイルコピー | 完全なスナップショット |

### SQLite設定

```sql
-- パフォーマンス最適化
PRAGMA journal_mode = WAL;      -- Write-Ahead Logging
PRAGMA foreign_keys = ON;       -- 外部キー制約有効化
PRAGMA synchronous = NORMAL;    -- 書き込み性能とのバランス
```

### バックアップ戦略

- **頻度**: 手動（ユーザー起動）
- **保存先**: ユーザー指定ディレクトリ（デフォルト: `./backups/`）
- **世代管理**: 設定可能（デフォルト: 最新5世代を保持）
- **復元方法**: `BackupManager.restore(backup_path)`

## パフォーマンス要件

### レスポンスタイム

| 操作 | 目標時間 | 測定環境 |
|------|---------|---------|
| 識別子解決 | 5ms以内 | 1000銘柄登録時 |
| 単一レコード挿入 | 10ms以内 | 標準PC |
| 1000件一括挿入 | 1秒以内 | 標準PC |
| 250件取得（1年分） | 100ms以内 | インデックス使用時 |

### インデックス戦略

```sql
-- 識別子検索用
CREATE INDEX idx_security_identifiers_lookup
    ON security_identifiers(identifier_type, identifier_value);

-- 価格データ検索用
CREATE INDEX idx_price_data_security_date
    ON price_data(security_id, price_date);

-- ファクターデータ検索用
CREATE INDEX idx_factor_data_security_date
    ON factor_data(security_id, observation_date);
```

### リソース使用量

| リソース | 上限 | 理由 |
|---------|------|------|
| メモリ | 100MB | 一般的なデータ操作時 |
| ディスク | 無制限（データ依存） | 10年分で約100MB想定 |

## セキュリティアーキテクチャ

### データ保護

- **暗号化**: 対象外（個人利用、ローカルファイル前提）
- **アクセス制御**: OSのファイルパーミッションに依存
- **機密情報管理**: 該当なし

### 入力検証

- **バリデーション**:
  - 識別子タイプ: 定義済みタイプのみ許可
  - 日付: ISO8601形式
  - 数値: 型チェック
- **サニタイゼーション**: パラメータ化クエリによるSQLインジェクション防止
- **エラーハンドリング**: 詳細なエラーメッセージ（開発用途のため）

## スケーラビリティ設計

### データ増加への対応

- **想定データ量**:
  - 銘柄: 1,000件
  - 価格データ: 100,000件（10年分）
  - ファクターデータ: 1,000,000件
- **パフォーマンス劣化対策**:
  - 適切なインデックス設計
  - バッチ挿入の使用
- **アーカイブ戦略**: ユーザー判断（古いデータの削除はサポート）

### 機能拡張性

- **プラグインシステム**: なし（ライブラリとして拡張）
- **設定のカスタマイズ**:
  - バックアップ世代数
  - データソース優先度
- **API拡張性**:
  - 新しい識別子タイプの追加
  - 新しいファクターカテゴリの追加
  - 将来的な他DB対応（抽象化レイヤー設計）

## テスト戦略

### ユニットテスト
- **フレームワーク**: pytest
- **対象**:
  - IdentifierResolver: パターンマッチング、解決ロジック
  - 各Repository: CRUD操作
  - バリデーション関数
- **カバレッジ目標**: 80%

### 統合テスト
- **方法**: インメモリSQLite（`:memory:`）を使用
- **対象**:
  - 銘柄作成 → 識別子追加 → データ保存 → 取得の一連フロー
  - トランザクションのコミット/ロールバック
  - 複数ソースデータの優先度処理

### プロパティベーステスト
- **ツール**: Hypothesis
- **シナリオ**:
  - 任意の識別子値での解決・作成サイクル
  - 日付範囲の境界条件

## 技術的制約

### 環境要件
- **OS**: Windows, macOS, Linux
- **Python**: 3.12以上
- **最小メモリ**: 50MB
- **必要ディスク容量**: 10MB（ライブラリ） + データ量
- **必要な外部依存**: structlog, rich, filelock

### パフォーマンス制約
- SQLiteの同時書き込み制限（WALモードで緩和）
- 大量データの一括取得時のメモリ使用量

### セキュリティ制約
- ローカルファイルアクセスのみ（ネットワーク機能なし）
- ユーザー認証なし（単一ユーザー前提）

## 依存関係管理

| ライブラリ | 用途 | バージョン管理方針 |
|-----------|------|-------------------|
| structlog | 構造化ログ | 範囲指定（>=25.4.0） |
| rich | コンソール表示 | 範囲指定（>=13.7.0） |
| filelock | ファイルロック | 範囲指定（>=3.20.1） |
| pytest | テスト | 開発依存、範囲指定 |
| hypothesis | プロパティテスト | 開発依存、範囲指定 |
| pyright | 型チェック | 開発依存、範囲指定 |
| ruff | リント | 開発依存、範囲指定 |

## ディレクトリ構成（概要）

```
src/database_utils/
├── __init__.py           # 公開API
├── types.py              # 型定義
├── exceptions.py         # カスタム例外
├── core/
│   ├── connection.py     # DatabaseConnection
│   ├── schema.py         # スキーマ定義（SQL）
│   ├── identifier.py     # IdentifierResolver
│   └── repositories/
│       ├── security.py   # SecurityRepository
│       ├── price.py      # PriceRepository
│       ├── factor.py     # FactorRepository
│       └── ...
└── utils/
    ├── backup.py         # BackupManager
    └── logging_config.py # ログ設定
```
