# プロダクト要求定義書 (Product Requirements Document)

## プロダクト概要

### 名称
**database-utils** - 金融データ管理のためのSQLiteユーティリティ

### プロダクトコンセプト
- **複数識別子の統一管理**: ISIN, CUSIP, SEDOL, Bloomberg ticker, Yahoo ticker等を内部IDで統一
- **マルチソース対応**: yfinance、Excel、手入力など複数ソースからのデータを追跡可能
- **ファクター/特徴量管理**: 分析で作成したファクターや特徴量をソース別に管理
- **安全なバックアップ**: 自動・手動バックアップによるデータ保全

### プロダクトビジョン
個人投資家が金融データ（株価、ファクター、取引履歴）を一元管理できるPythonライブラリを提供する。
複数の外部識別子（ISIN, ticker等）を内部IDで統一し、異なるデータソースからのデータを
シームレスに統合・管理できる。SQLiteの軽量さを活かしつつ、データリネージュ（来歴）を
追跡可能な設計とする。

### 目的
- 複数の識別子タイプを持つ銘柄を統一的に管理する
- 複数データソース（yfinance、Excel等）からのデータを来歴付きで保存する
- ファクター/特徴量データを効率的に管理する
- データのバックアップと復元を容易にする

## ターゲットユーザー

### プライマリーペルソナ: 個人投資家（開発者）
- Pythonを使用した金融データ分析・ファクター投資を行う個人投資家
- 複数のデータソース（yfinance、Excel、Bloomberg等）からデータを収集
- 銘柄ごとに複数の識別子（証券コード、ticker、ISIN等）を扱っている
- ファクターや特徴量を計算し、どのソースから作成したか追跡したい
- ローカル環境でデータを管理したい（クラウド依存を避けたい）

### 1日の典型的なワークフロー
1. 朝: yfinanceから株価データを取得・保存
2. 日中: Excelから財務データをインポート、ファクター計算
3. 夕方: 計算したファクター値をデータベースに保存
4. 週末: バックアップ実行、複数ソースのデータを統合して分析

## 成功指標(KPI)

### プライマリーKPI（個人利用のため定性的）
- データ操作の信頼性: データ損失ゼロ
- 識別子解決の正確性: 異なる識別子で同一銘柄を正しく認識
- ソース追跡の完全性: 全データの来歴を追跡可能

### セカンダリーKPI
- テストカバレッジ: 80%以上
- ドキュメント整備: 全公開APIにdocstring完備

## 機能要件

### コア機能(MVP)

#### 1. データベース接続管理

**ユーザーストーリー**:
個人投資家として、SQLiteデータベースに簡単に接続するために、接続管理機能が欲しい

**受け入れ条件**:
- [ ] データベースファイルパスを指定して接続できる
- [ ] コンテキストマネージャでの接続管理をサポートする
- [ ] トランザクション管理（コミット/ロールバック）ができる
- [ ] 接続エラー時に適切な例外を発生させる

**優先度**: P0(必須)

#### 2. 銘柄マスタ・識別子管理

**ユーザーストーリー**:
個人投資家として、複数の識別子を持つ銘柄を統一的に管理するために、識別子マッピング機能が欲しい

**受け入れ条件**:
- [ ] 銘柄に内部ID（整数）を自動付与できる
- [ ] 同一銘柄に複数の識別子（ISIN, CUSIP, ticker等）を登録できる
- [ ] 任意の識別子から内部IDを解決できる
- [ ] 識別子タイプを自動検出できる（ISIN形式、日本の証券コード等）
- [ ] 識別子の変更履歴を管理できる（企業再編等に対応）

**対応する識別子タイプ**:
- ISIN（国際証券識別番号）
- CUSIP（米国・カナダ）
- SEDOL（英国）
- Bloomberg ticker（例: 7203 JP Equity）
- Yahoo Finance symbol（例: 7203.T）
- 日本の証券コード（4桁）
- FIGI（Financial Instrument Global Identifier）

**優先度**: P0(必須)

#### 3. データソース管理

**ユーザーストーリー**:
個人投資家として、データの来歴を追跡するために、データソース管理機能が欲しい

**受け入れ条件**:
- [ ] データソース（yfinance, Excel, manual等）を登録できる
- [ ] 各ソースが使用する識別子タイプを設定できる
- [ ] ソースに優先度を設定できる（競合時の解決用）
- [ ] データ取り込み履歴を記録できる

**優先度**: P0(必須)

#### 4. 株価データ管理（OHLCV）

**ユーザーストーリー**:
個人投資家として、株価データを保存・取得するために、OHLCVデータのCRUD機能が欲しい

**受け入れ条件**:
- [ ] 株価データ（日付、OHLCV、調整後終値）を保存できる
- [ ] ソース別にデータを保持できる（同一日付でも複数ソース可）
- [ ] 内部IDまたは外部識別子で株価データを取得できる
- [ ] 優先度に基づく「ベストデータ」を取得できる
- [ ] 重複データの挿入時にupsert（更新または挿入）ができる

**優先度**: P0(必須)

#### 5. ファクター/特徴量管理

**ユーザーストーリー**:
個人投資家として、計算したファクターや特徴量を管理するために、ファクターデータ管理機能が欲しい

**受け入れ条件**:
- [ ] ファクター定義（名前、カテゴリ、説明、計算式メモ）を登録できる
- [ ] ファクター値を銘柄・日付・ソース別に保存できる
- [ ] 最新のファクター値を一括取得できる
- [ ] ファクターのカテゴリ別（momentum, value, quality等）に取得できる

**優先度**: P0(必須)

#### 6. 取引履歴管理

**ユーザーストーリー**:
個人投資家として、売買履歴を記録するために、取引履歴のCRUD機能が欲しい

**受け入れ条件**:
- [ ] 取引データ（銘柄、日付、売買区分、数量、単価、手数料）を保存できる
- [ ] 銘柄別・期間別に取引履歴を取得できる
- [ ] 取引履歴の修正・削除ができる

**優先度**: P1(重要)

#### 7. ポートフォリオ管理

**ユーザーストーリー**:
個人投資家として、保有資産を追跡するために、ポートフォリオ管理機能が欲しい

**受け入れ条件**:
- [ ] 現在の保有銘柄と数量を記録できる
- [ ] 各銘柄の取得単価と評価額を管理できる
- [ ] ポートフォリオ全体の評価額を算出できる

**優先度**: P1(重要)

#### 8. バックアップ機能

**ユーザーストーリー**:
個人投資家として、データを安全に保管するために、バックアップ機能が欲しい

**受け入れ条件**:
- [ ] 指定したディレクトリにデータベースのバックアップを作成できる
- [ ] バックアップにタイムスタンプを付与できる
- [ ] 古いバックアップの自動削除（世代管理）ができる
- [ ] バックアップからの復元ができる

**優先度**: P1(重要)

### Pythonインターフェース

```python
from database_utils import DatabaseConnection, IdentifierResolver

# 接続
with DatabaseConnection("portfolio.db") as db:
    # 識別子解決（外部ID → 内部ID）
    resolver = IdentifierResolver(db)

    # 任意の識別子で銘柄を検索
    security_id = resolver.resolve("7203", identifier_type="JP_CODE")
    security_id = resolver.resolve("7203.T", identifier_type="TICKER_YAHOO")
    security_id = resolver.resolve("JP3633400001", identifier_type="ISIN")

    # 自動タイプ検出
    security_id = resolver.resolve_auto("US0378331005")  # ISINと自動判定

    # 株価データ操作（外部識別子で直接アクセス可能）
    db.prices.upsert(
        identifier="7203.T",
        identifier_type="TICKER_YAHOO",
        date="2025-01-01",
        open=2500, high=2550, low=2480, close=2530,
        volume=1000000,
        source_code="YAHOO"
    )

    # 優先度に基づくベストデータ取得
    prices = db.prices.get_best(
        identifier="7203",
        identifier_type="JP_CODE",
        start_date="2025-01-01"
    )

    # ソース指定での取得
    yahoo_prices = db.prices.get(
        security_id=security_id,
        source_code="YAHOO"
    )

    # ファクター/特徴量の保存
    db.factors.define(
        factor_code="momentum_20d",
        name="20日モメンタム",
        category="momentum",
        description="過去20日間のリターン"
    )

    db.factors.upsert(
        security_id=security_id,
        factor_code="momentum_20d",
        date="2025-01-01",
        value=0.05,
        source_code="DERIVED_CALC"
    )

    # 最新ファクター値の取得
    latest = db.factors.get_latest(security_id=security_id)

# バックアップ
from database_utils import BackupManager

backup = BackupManager("portfolio.db", backup_dir="./backups")
backup.create()
backup.restore("backup_2025-01-01.db")
```

### 将来的な機能(Post-MVP)

#### CSVインポート機能

CSVファイルからのデータ一括インポート

**優先度**: P1(重要)

#### 外部APIアダプター

yfinance等からの自動データ取得ラッパー

**優先度**: P2(できれば)

#### 他データベース対応

PostgreSQL、MySQLへの対応

**優先度**: P2(できれば)

## 非機能要件

### パフォーマンス
- 単一レコードの挿入: 10ms以内
- 1000件の一括挿入: 1秒以内
- 1年分の株価データ取得（約250件）: 100ms以内
- 識別子解決: 5ms以内

### ユーザビリティ
- 全公開APIにGoogle形式のdocstringを完備
- 主要操作のサンプルコードをREADMEに記載
- 型ヒント完備でIDE補完をサポート

### 信頼性
- トランザクション管理によるデータ整合性保証
- 外部キー制約による参照整合性
- 自動バックアップによるデータ損失防止

### セキュリティ
- SQLインジェクション対策（パラメータ化クエリの使用）
- ファイルパスのバリデーション

### スケーラビリティ
- 10年分のデータ（約10万件）を扱える設計
- 1000銘柄以上の管理に対応

## スコープ外

明示的にスコープ外とする項目:
- Webインターフェース（CLIやAPIサーバーは対象外）
- リアルタイムデータ配信
- マルチユーザー対応
- クラウドストレージとの同期
- 暗号化されたデータベースファイル
- 外部APIとの直接連携（アダプターはユーザーが実装）
