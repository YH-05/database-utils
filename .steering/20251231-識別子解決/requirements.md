# 識別子解決 - 要件定義

## 機能概要

外部識別子（ISIN、CUSIP、SEDOL、Bloomberg ticker、Yahoo ticker、日本証券コード、FIGI）から内部ID（security_id）への解決機能を提供する。

## 機能要件

### FR-1: 識別子タイプ指定での解決

- 識別子の値とタイプを指定して内部IDに解決できる
- 有効期間（valid_from/valid_to）を考慮したポイントインタイム解決
- 該当なしの場合は None を返す

### FR-2: 識別子タイプの自動検出

- 識別子のパターンからタイプを自動検出して解決
- ISIN: 2文字国コード + 9文字英数字 + 1文字チェックディジット（12文字）
- CUSIP: 9文字英数字
- SEDOL: 7文字英数字
- JP_CODE: 4桁数字
- FIGI: 3文字 + 9文字英数字
- パターンマッチしない場合はティッカーとして検索

### FR-3: 解決または新規作成

- 識別子が見つからない場合、新規銘柄を作成して返す
- 銘柄名が必須パラメータ
- 作成と同時に識別子を登録

### FR-4: SecurityRepository による銘柄CRUD

- 銘柄の作成・取得・更新・削除
- 識別子の追加・取得
- 銘柄検索（名前、識別子）

## 非機能要件

### NFR-1: パフォーマンス

- 識別子解決: 5ms以内（1000銘柄時）
- インデックス活用による高速検索

### NFR-2: データ整合性

- 外部キー制約の遵守
- 識別子の一意性保証（タイプ + 値 + 有効開始日）

### NFR-3: ロギング

- 全操作でstructlogによる構造化ログ出力
- エラー時はexc_info付きでログ

## カスタム例外

- `IdentifierNotFoundError`: 識別子が見つからない
- `DuplicateSecurityError`: 銘柄の重複
- `ValidationError`: 入力値不正
